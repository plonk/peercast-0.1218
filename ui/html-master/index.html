{^define LAYOUT layout.html}
{^define TITLE}{#_Information_navbar} - {#PeerCast on} {^SERVER_NAME}{^end}

{@if servMgr.disabled}
<div align="center" class="normal">
  <p><strong><font color="#FF0000">Broadcasting has been disabled</font></strong></p>
  <p><strong><font color="#FF0000">Please contact peercast.org</font></strong></p>
</div>
{@end}

<div>
<a id="portcheck4" href="/admin?cmd=portcheck4">{#Check} (IPv4)</a> -
<a id="portcheck6" href="/admin?cmd=portcheck6">{#Check} (IPv6)</a>
</div>

<DIV align=center class="reloader flex-container" data-url="index.html?fragment=content" data-interval="{$servMgr.refreshHTML}">
  {@fragment content}
  <div class="column">
  <TABLE class="table-panel" align=center border=0>
    <TR align=middle>
      <TD colSpan=2 class="normal"><B>{#Information}</B></TD>
    </TR>
    <TR align=left>
      <th class="left-heading">{#Server IP} (v4)</th>
      <TD>{$servMgr.serverIP}</TD>
    </TR>
    <TR align=left>
      <th class="left-heading">{#Server IP} (v6)</th>
      <TD>{$servMgr.serverIPv6}</TD>
    </TR>
    <TR align=left>
      <th class="left-heading">{#Uptime}</th>
      <TD>{$servMgr.uptime}</TD>
    </TR>
    <TR align=left>
      <th class="left-heading">{#Channel cache}</th>
      <TD>{$chanMgr.numHitLists} - <a href="/admin?cmd=clear&amp;hitlists=1">{#Clear}</a> - <a href="/admin?cmd=dump_hitlists">{#Dump}</a></TD>
    </TR>
    <TR align=left>
      <th class="left-heading">{#Firewalled} (v4)</th>
      <TD>{@if servMgr.firewallKnown} {@if servMgr.isFirewalled}
        {#Yes} {@else} {#No} {@end} {@else} {#Unknown} {@end}
        {@if servMgr.flags.forceFirewalled} <b title="{#The forceFirewalled flag is on.}">{#(forced)}</b> {@end}
      </TD>
    </TR>
    <TR align=left>
      <th class="left-heading">{#Firewalled} (v6)</th>
      <TD>{@if servMgr.firewallKnownIPv6} {@if servMgr.isFirewalledIPv6}
        {#Yes} {@else} {#No} {@end} {@else} {#Unknown} {@end}
        {@if servMgr.flags.forceFirewalled} <b title="{#The forceFirewalled flag is on.}">{#(forced)}</b> {@end}
        </TD>
    </TR>
    <TR align=left>
      <th class="left-heading">{#XML stats}</th>
      <TD><A href="/admin?cmd=viewxml">{#View}</A></TD>
    </TR>
    <tr align=left>
      <th class="left-heading">{#YP Address}</th>
      <td>{$servMgr.ypAddress}</td>
    </tr>
    <tr align=left>
      <th class="left-heading" title="{#Message from the root server}">{#YP message}</th>
      <td>{$servMgr.rootMsg}</td>
    </tr>
    <TR align=left>
      <th class="left-heading">{#Host options}</th>
      <TD>{@if servMgr.isRoot}{#Root}{@end} {@if servMgr.isPrivate}{#Licensed}{@end} {@if servMgr.forceYP}{#ForceYP}{@end}</TD>
    </TR>
    <tr align=left>
      <th class="left-heading">{#Installation directory}</th>
      <td>{$servMgr.installationDirectory}</td>
    </tr>
    <tr align=left>
      <th class="left-heading">{#Configuration file}</th>
      <td>{$servMgr.configurationFile}</td>
    </tr>
    <tr align=left>
      <th class="left-heading">{#Build date and time}</th>
      <td>{$servMgr.buildDateTime}</td>
    </tr>
  </TABLE>

  <table class="table-panel" class="normal">
    <tr>
      <th colspan="2">{#Channel Feeds}</th>
    </tr>

    {@loop servMgr.numChannelFeeds}
    <tr>
      <td>{$loop.channelFeed.url}</td>
      <td align="center">{$loop.channelFeed.status}</td>
    </tr>
    {@end}
  </table>
  </div>

  <div class="column">
  <TABLE class="table-panel" align=center border=0>
    <TR align=middle>
      <TD colSpan=3 class="normal"><B>{#Bandwidth}</B></TD>
    </TR>
    <TR align=left class="normal">
      <th class="left-heading"></th>
      <TH>{#In}</TH>
      <TH>{#Out}</TH>
    </TR>
    <TR align=left class="normal">
      <th class="left-heading">{#Internet (Kbit/s)}</th>
      <TD class="bandwidth-cell">{$stats.wanInPerSec}</TD>
      <TD class="bandwidth-cell">{$stats.wanOutPerSec}</TD>
    </TR>
    <TR align=left class="normal">
      <th class="left-heading">{#Total (Kbit/s)}</th>
      <TD class="bandwidth-cell">{$stats.totalInPerSec}</TD>
      <TD class="bandwidth-cell">{$stats.totalOutPerSec}</TD>
    </TR>
  </TABLE>

  <table class="table-panel" border="0">
    <tr>
      <td colspan="2"><div align="center" class="normal"><strong>{#Connections}</strong></div></td>
    </tr>
    <tr>
      <th class="left-heading" width="66%">{#Direct}</th>
      <td width="34%" class="normal">{$servMgr.numDirect}</td>
    </tr>
    <tr>
      <th class="left-heading">{#Relay}</th>
      <td class="normal">{$servMgr.numRelays}</td>
    </tr>
    <tr>
      <th class="left-heading">{#CIN / COUT}</th>
      <td>{$servMgr.numCIN} / {$servMgr.numCOUT}</td>
    </tr>
    <tr>
      <th class="left-heading">{#Incoming}</th>
      <td>{$servMgr.numIncoming}</td>
    </tr>
    <tr>
      <th class="left-heading">{#Port} {$servMgr.serverPort1}</th>
      <td>{$servMgr.numActive1}</td>
    </tr>
  </table>
  </div>
  {@end}
</DIV>


  <script>
  $(function(){
      $("#portcheck4").click(function (ev){
          ev.preventDefault();
          $("#console").text("");
          $("#modal").show();
          fetch("/admin?cmd=portcheck4").then(res => {
            var reader = res.body.getReader();
            var f = ({done, value}) => {
              if (!done) {
                var addition = new TextDecoder().decode(value);
                $("#console").text($("#console").text() + addition);
                reader.read().then(f);
              } else {
                $("#console").text($("#console").text() + "コマンドは正常に終了しました。");
              }
            };
            reader.read().then(f);
          });
      });
      $("#portcheck6").click(function (ev){
          ev.preventDefault();
          $("#console").text("");
          $("#modal").show();
          fetch("/admin?cmd=portcheck6").then(res => {
            var reader = res.body.getReader();
            var f = ({done, value}) => {
              if (!done) {
                var addition = new TextDecoder().decode(value);
                $("#console").text($("#console").text() + addition);
                reader.read().then(f);
              } else {
                $("#console").text($("#console").text() + "コマンドは正常に終了しました。");
              }
            };
            reader.read().then(f);
          });
      });
      $("#close_button").click(ev => { $("#modal").hide() });
  });
  </script>

<style>
.blink_me {
  color: white;
  animation: blinker 1.0s linear infinite;
}

@keyframes blinker {
  50% {
    opacity: 0;
  }
}
</style>

<div id="modal" style="display: none; position: fixed; top: 0; bottom: 0; left: 0; right: 0; text-align: left">
  <div 
     style="box-shadow: 2px 2px 6px 6px rgba(0,0,0,0.1); width: 600px; position: relative; margin: 30px auto; background-color: gray; border: solid 1px blue">
    <div id="title-bar" style="color: white; background-color: blue; font-size: 10pt; font-family: Meiryo, 'MS UI Gothic'; padding: 2px">
    <img src="favicon.ico" type="image/vnd.microsoft.icon" style="vertical-align: middle">
    コンソール
    <button id="close_button" style="float: right; font-weight: bold; padding: 0px 2px 0px 2px">×</button>
    </div>
    <div style="word-break: break-all; white-space: pre-wrap; margin: 0; min-height: 24em; font-family: 'MS Gothic', 'Lucida Console', monospace; background-color: black; color: #aaa"><span id="console"></span><span class="blink_me">█</span></div>
  </div>
</div>
